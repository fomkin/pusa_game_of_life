Как-то я читал OpenNet и наткнулся на новость о PHP-фреймворке Pusa, переносящий логику JavaScript-фронтэнда на сторону сервера. Я сразу же заинтересовался, так как сам занимаюсь подобным и последние пять лет развиваю библиотеку Korolev для языка программирования Scala. Мы с автором пообщались и договорились, что напишем совместную статью, где он опишет свое понимание и опыт использования Korolev, а я опишу то же самое для Pusa.

Для меня подготовка к этой статье стала чем-то вроде возвращения в юность, когда PHP в вебе был мейнстримом, и для любого молодого человека являлся языком по-умолчанию (конечно если у него не было наставника в виде преподователя-который-любит-все-от-microsoft). Много воды утекло с тех пор. Опыт представлялся волнующим, чем-то вроде встречи, спустя много лет, с девушкой, что подарила первый поцелуй. Чтобы немного развлечь себя и тебя, дорогой читатель, в качестве своего ознакомительного прокета на Pusa я выбрал Игру "Жизнь" Конвея. Немного нестандартное применение веб-технологии, но тем лучше.

Для начала я открыл [руководство](https://gitlab.com/catlair/pusa/-/tree/main) и пошел по шагам. Разрабатывать предлагается внутри специально подготовленного Docker-контейнера. Для меня это несколько неудобно. Я привык IDE и аскетичные редактор nano, который поставляется в образе замедлил бы мое знакомство с фреймворком. Поэтому я немного поменял порты и примонтировал volume, чтобы можно было работат с файлами с хост-машины. Выполнив несложную инструкцию я получил это.

-- СКРИНШОТ --

Работает!

Теперь перейдем к задаче. Прежде чем трогать Pusa, я сделаю реализацию правил Игры "Жизнь" на PHP. Для тех кто не в курсе, игра "жизнь" заключается в том чтобы по некоторым правилам переводить клетки на двумерном поле между двумя состояниями -- живая и мертвая. Поле в игре "Жизнь" называется "вселенной". Правила очень простые и их всего три:

1. Если клетка мертвая и у нее есть три живых соседа, то клетка оживает.
2. Если клетка живая и у нее меньше двух живых соседей, то она умирает.
3. Если клетка живая и у нее больше трех живых соседей, то она умирает.

Если вы уже видели или сами писали реализацию "жизни", то можете смело пропускать эту часть. В конечном счете получится функция, которая принимает вселенную и изменяет ее в соответствии с правилами описанными выше. 

Определим вселенную в виде одномерного массива для простоты. Живая клетка будет соответствовать единице, мертвая нулю.

```php
$gol_universe_side_size = 10;
$gol_universe = array_fill(0, $gol_universe_side_size * 2, 0);
```

Вселенная будет подобна поверхности тора. То есть, то что уехало правый нижний угол, приедет из левого верхнего.

```
function gol_cell_index($universe, $x, $y) {
  $size = $gol_universe_side_size;
  return ($x % $size + $size) % $size + ($y % $size + $size) % $size * $size;
}

function gol_cell_get($universe, $x, $y) {
  $index = gol_cell_index($universe, $x, $y);
  return $universe[$index];
}

function gol_cell_set($universe, $x, $y, $value) {
  $index = gol_cell_index($universe, $x, $y);
  $universe[$index] = $value;
}        
```

Напишем функцию, которая будет подсчитывать количество живых соседей.

```php
function gol_cell_count_alive_neighbors($universe, $x, $y) {
  return
    // Верхний ряд соседей 
    gol_cell_get($universe, $x-1, $y-1) +
    gol_cell_get($universe, $x, $y-1) +
    gol_cell_get($universe, $x+1, $y-1) +
    // Левый и правый
    gol_cell_get($universe, $x-1, $y) +
    gol_cell_get($universe, $x+1, $y) +
    // Нижний ряд
    gol_cell_get($universe, $x-1, $y+1) +
    gol_cell_get($universe, $x, $y+1) +
    gol_cell_get($universe, $x+1, $y+1);        
}
```

Определим правила.

```php
function gol_cell_must_resurrect($universe, $x, $y) {
  return gol_cell_count_alive_neighbors($universe, $x, $y) == 3;
}

function gol_cell_must_die($universe, $x, $y) {
  $alive = gol_cell_count_alive_neighbors($universe, $x, $y);
  return $alive < 2 || $alive > 3;
}
```

Научимся применять правила ко вселенной.

```php
function $gol_universe_transform($universe) {
  $size = $gol_universe_side_size;
  for ($y = 0; $y++; $y < $size) {
    for ($x = 0; $x++; $x < $size) {
      $value = gol_cell_get($universe, $x, $y);
      if ($value == 0 && gol_cell_must_resurrect($universe, $x, $y)) {
        gol_cell_set($universe, $x, $y, 1);
      } else ($value == 1 && gol_cell_must_die($universe, $x, $y)) {
        gol_cell_set($universe, $x, $y, 0);
      } 
    }
  }
}
```



